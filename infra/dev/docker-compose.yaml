services:
  voice-chat-mongo:
    image: mongo:8.0
    container_name: ${MONGO_CONTAINER_NAME}
    restart: unless-stopped
    command: mongod --replSet rs0 --bind_ip_all
    ports:
      - "${MONGO_PORT}:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - voice-chat-network

  mongo-setup:
    image: mongo:8.0
    container_name: mongo-setup
    restart: "no"
    depends_on:
      - ${MONGO_CONTAINER_NAME}
    command: >
      bash -c "
      echo 'Waiting for MongoDB...' &&
      sleep 15 &&

      echo '=== Initializing replica set ===' &&
      mongosh --host ${MONGO_CONTAINER_NAME}:${MONGO_PORT} --eval \"
        rs.initiate({
          _id: 'rs0',
          members: [{ _id: 0, host: '${MONGO_CONTAINER_NAME}:${MONGO_PORT}' }]
        });
      \" &&

      echo 'Waiting for replica set...' &&
      sleep 10 &&

      echo '=== Creating user ===' &&
      mongosh --host ${MONGO_CONTAINER_NAME}:${MONGO_PORT} --eval \"
        db.getSiblingDB('admin').createUser({
          user: '${MONGO_USER}',
          pwd: '${MONGO_PASSWORD}',
          roles: [{ role: 'root', db: 'admin' }]
        });
      \" &&

      echo '=== Setup complete! ==='
      "
    networks:
      - voice-chat-network

networks:
  voice-chat-network:
    driver: bridge

volumes:
  mongo-data:
